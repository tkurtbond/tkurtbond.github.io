<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Logging the output of long commands run multiple times | Lacking Natural Simplicity</title>
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../../rss.xml">
<link rel="alternate" type="application/atom+xml" title="Atom" href="../../../../../feed.atom">
<link rel="canonical" href="https://tkurtbond.github.io/posts/2021/07/07/logging-the-output-of-long-commands-run-multiple-times/">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="T. Kurt Bond">
<link rel="prev" href="../../06/another-thing-i-really-liked-about-advanced-fighting-fantasy-1e/" title="Another Thing I Really Liked About Advanced Fighting Fantasy 1E" type="text/html">
<link rel="next" href="../advanced-fighting-fantasy-2e-combat-companion/" title="Advanced Fighting Fantasy 2E Combat Companion" type="text/html">
<meta property="og:site_name" content="Lacking Natural Simplicity">
<meta property="og:title" content="Logging the output of long commands run multiple times">
<meta property="og:url" content="https://tkurtbond.github.io/posts/2021/07/07/logging-the-output-of-long-commands-run-multiple-times/">
<meta property="og:description" content="I often run commands that produce a lot of output that needs to saved
for debugging, and often the commands have to be repeated multiple
times to get things to work.  For example, building software fr">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-07-07T12:47:25-04:00">
<meta property="article:tag" content="bash">
<meta property="article:tag" content="logging">
<meta property="article:tag" content="unix">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<div class="blog-masthead">
    <div class="container">
<!-- This keeps the margins nice -->
        <nav class="blog-nav" role="navigation"><a href="../../../../../index.html" class="blog-nav-item">Home</a>
            <a href="../../../../../archive.html" class="blog-nav-item">Archives</a>
            <a href="../../../../../categories/index.html" class="blog-nav-item">Tags &amp; Categories</a>
            <a href="../../../../../rss.xml" class="blog-nav-item">RSS feed</a>
            <a href="../../../../../feed.atom" class="blog-nav-item">Atom feed</a>

            

    <a href="index.rst" class="blog-nav-item blog-nav-item-aside" id="sourcelink">Source</a>
                
            
        </nav>
</div>
<!-- /.container -->
</div>
<!-- End of Menubar -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <div class="blog-header">
            <h1 class="blog-title">
                <a href="https://tkurtbond.github.io/">

                    <span id="blog-title">Lacking Natural Simplicity</span>
                </a>
            </h1>
            <p class="lead blog-description">Random musings on books, code, and tabletop games.</p>
            
        </div>
        <!--Body content-->
        <div class="row">
            <div class="col-sm-8 blog-main">
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h2 class="p-name entry-title blog-post-title" itemprop="headline name"><a href="." class="u-url">Logging the output of long commands run multiple times</a></h2>

        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">T. Kurt Bond</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-07-07T12:47:25-04:00" itemprop="datePublished" title="2021-07-07 12:47">2021-07-07 12:47</time></a></p>
                <p class="commentline">            <a href="#disqus_thread" data-disqus-identifier="cache/posts/2021/07/07/logging-the-output-of-long-commands-run-multiple-times.html">Comments</a>


                    </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>I often run commands that produce a lot of output that needs to saved
for debugging, and often the commands have to be repeated multiple
times to get things to work.  For example, building software from
source, often using the familiar <code class="docutils literal">./configure; make; make install</code>
paradigm.</p>
<p>So, the first thing is to try is to use the venerable <span class="command">tee</span> command.</p>
<pre class="code bash"><a name="rest_code_4edf7ed7d2c343c0b80ea12d1acc7981-1"></a>./configure <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee Log.configure
<a name="rest_code_4edf7ed7d2c343c0b80ea12d1acc7981-2"></a>make <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee Log.make
<a name="rest_code_4edf7ed7d2c343c0b80ea12d1acc7981-3"></a>make install <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee Log.make-install
</pre>
<p>To make the log files easy to find I use a <span class="file">Log.</span> prefix.</p>
<p>But I often need to run the commands multiple times, and want to save
each run under a new filename, so if the filename already exists I
want to add a number to the end and then increment the number until I
find one that hasn't been used.  And I'd like the filename to have the
date in YYYY-MM-DD format, so the resulting names look like
<span class="file">Log.make-install-2021-07-07_2</span>.</p>
<p>So I wrote a bash function <span class="command">incf</span> (increment filename) to put in
<span class="file">.bashrc</span> that generates such a name:</p>
<pre class="code bash"><a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-1"></a>incf <span class="o">()</span> <span class="o">{</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-2"></a>    <span class="c1"># Construct a filename from PREFIX, "_YYYY-MM-DD",  optionally _N (where N</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-3"></a>    <span class="c1"># is 1 or greater) if the filename already exists, and optionally SUFFIX.</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-4"></a>    <span class="c1"># Example: "incf file .tar.gz" results in "file_2021-07-07.tar.gz", or</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-5"></a>    <span class="c1"># "file_2021-07-07_N.tar.gz" if "file_2021-07-07.tar.gz" already exists,</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-6"></a>    <span class="c1"># where N is 1 or greater.</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-7"></a>    <span class="nb">local</span> prefix suffix fileprefix i testname sep1 sep2
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-8"></a>    <span class="nv">prefix</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-9"></a>    <span class="nv">suffix</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-10"></a>    <span class="nv">sep1</span><span class="o">=</span><span class="s2">"_"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-11"></a>    <span class="nv">sep2</span><span class="o">=</span><span class="s2">"_"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-12"></a>    <span class="nv">fileprefix</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">prefix</span><span class="si">}${</span><span class="nv">sep1</span><span class="si">}</span><span class="k">$(</span>date +%F<span class="k">)</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-13"></a>    <span class="nb">let</span> <span class="nv">i</span><span class="o">=</span><span class="m">0</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-14"></a>    <span class="c1"># The zeroth filename doesn't have the number.</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-15"></a>    <span class="nv">testname</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">fileprefix</span><span class="si">}${</span><span class="nv">suffix</span><span class="si">}</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-16"></a>    <span class="k">while</span> <span class="nb">true</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-17"></a>    <span class="k">do</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-18"></a>      <span class="o">[</span> ! -e <span class="s2">"</span><span class="nv">$testname</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-19"></a>      <span class="o">((</span>i++<span class="o">))</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-20"></a>      <span class="nv">testname</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">fileprefix</span><span class="si">}${</span><span class="nv">sep2</span><span class="si">}${</span><span class="nv">i</span><span class="si">}${</span><span class="nv">suffix</span><span class="si">}</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-21"></a>    <span class="k">done</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-22"></a>    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$testname</span><span class="s2">"</span>
<a name="rest_code_bc2fbc886e3644ceb047ec476fdd93a1-23"></a><span class="o">}</span>
</pre>
<p>And then I wrote a bash function that uses <span class="command">incf</span> to generate
the <span class="file">Log.</span> filename, potentially in a different directory:</p>
<pre class="code bash"><a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-1"></a>logf <span class="o">()</span> <span class="o">{</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-2"></a>    <span class="c1"># Construct a filename, possibly in another directory, that starts with</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-3"></a>    <span class="c1"># "Log." and ends with "YYYY-MM-DD" and optionally "_N", where N is 1 or</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-4"></a>    <span class="c1"># greater, if the filename already exists.</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-5"></a>    <span class="nb">local</span> dn bn fn
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-6"></a>    <span class="nv">dn</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>dirname <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-7"></a>    <span class="nv">bn</span><span class="o">=</span><span class="s2">"Log.</span><span class="k">$(</span>basename <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-8"></a>    <span class="nv">fn</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>incf <span class="s2">"</span><span class="nv">$dn</span><span class="s2">/</span><span class="nv">$bn</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-9"></a>    <span class="nb">echo</span> <span class="nv">$fn</span>
<a name="rest_code_15ea5da8699b4a71b17143bb3a53886d-10"></a><span class="o">}</span>
</pre>
<p>And then I wrote a <span class="command">log</span> command that uses <span class="command">logf</span>
and tees its input into that file:</p>
<pre class="code bash"><a name="rest_code_4ac282306ed64e06867de0a40c0eb841-1"></a>log <span class="o">()</span> <span class="o">{</span>
<a name="rest_code_4ac282306ed64e06867de0a40c0eb841-2"></a>    <span class="c1"># tee the input into a log file.</span>
<a name="rest_code_4ac282306ed64e06867de0a40c0eb841-3"></a>    tee <span class="k">$(</span>logf <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="k">)</span>
<a name="rest_code_4ac282306ed64e06867de0a40c0eb841-4"></a><span class="o">}</span>
</pre>
<p>So running <code class="docutils literal">./configure <span class="pre">2&gt;&amp;1</span> | log ~/tmp/configure</code> generates a file
<span class="file">Log.configure_2021-07-07</span> in the <span class="file">~/tmp</span> directory.</p>
<p>But what if I specify a lot of options to the command, and would like
record if it in the log file, so if I get interrupted and then come
back some time later I can use the same command?</p>
<p>First I wrote a base function, <span class="command">cleanname</span>, that takes a string and
converts it to something that should be safe to use as a filename.</p>
<pre class="code bash"><a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-1"></a>cleanname <span class="o">()</span> <span class="o">{</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-2"></a>    <span class="c1"># Clean up a string so it is (relatively) safe to use as a filename.</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-3"></a>    <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> name
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-4"></a>    <span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cmd</span><span class="s2">"</span> <span class="p">|</span> sed <span class="s1">'s/[ =";?*&amp;^%$#@!~`|()&lt;&gt;]/-/g'</span> <span class="p">|</span> <span class="se">\</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-5"></a>               sed <span class="s2">"s#[/']#-#g"</span> <span class="p">|</span> sed -E <span class="s1">'s/--+/-/g'</span> <span class="p">|</span> <span class="se">\</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-6"></a>               sed -E <span class="s1">'s/(^[-.]+|-+$)//g'</span> <span class="p">|</span> <span class="se">\</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-7"></a>               sed -E <span class="s1">'s/\.\.\.*/./g'</span><span class="k">)</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-8"></a>    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$name</span><span class="s2">"</span>
<a name="rest_code_1bff1ba0efa64b45bcb89c282a374876-9"></a><span class="o">}</span>
</pre>
<p>Then I wrote a bash function, <span class="command">exlog</span>, to use the whole
command with its options as part of the filename (constructed with
<span class="command">cleanname</span>, and also include the whole command in the log output:</p>
<pre class="code bash"><a name="rest_code_a005e595ccfe4017ae540afd46f53c93-1"></a>exlog <span class="o">()</span> <span class="o">{</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-2"></a>    <span class="c1"># Execute a shell command and log it to "Log.&lt;cmd-as-safe-filename&gt;"</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-3"></a>    <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>cleanname <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-4"></a>    <span class="nv">name</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>logf <span class="nv">$name</span><span class="k">)</span><span class="s2">"</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-5"></a>    <span class="nb">printf</span> <span class="s1">'Logging to %s\n'</span> <span class="s2">"</span><span class="nv">$name</span><span class="s2">"</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-6"></a>    <span class="o">(</span><span class="nb">echo</span> <span class="s2">"cmd was: </span><span class="nv">$cmd</span><span class="s2">"</span><span class="p">;</span> <span class="nb">time</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee <span class="nv">$name</span>
<a name="rest_code_a005e595ccfe4017ae540afd46f53c93-7"></a><span class="o">}</span>
</pre>
<p>So running the command</p>
<pre class="code bash"><a name="rest_code_63af118345e54f2dbc0047506534cadc-1"></a>exlog ../configure --prefix<span class="o">=</span>/Users/tkb/sw/versions/groff/git
</pre>
<p>produces the file</p>
<pre class="code text"><a name="rest_code_bfab19bc84384340aa2fa953ab40c29f-1"></a>Log.configure-prefix-Users-tkb-sw-versions-groff-git_2021-07-07
</pre>
<p>and it contains the line</p>
<pre class="code text"><a name="rest_code_28438b8010f84974b59dcb7a0d1f19d9-1"></a>cmd was: ../configure --prefix=/Users/tkb/sw/versions/groff/git
</pre>
<p>and running it again produces the file</p>
<pre class="code text"><a name="rest_code_9cf8051e2cdb438ca1c7644afbbd57a4-1"></a>Log.configure-prefix-Users-tkb-sw-versions-groff-git_2021-07-07_1
</pre>
<p>This code is available in a <a class="reference external" href="https://gist.github.com/tkurtbond/23255fede737eec89b1fd0e011566cb1">gist</a>.</p>
<p><em>Last edited: 2021-07-09 15:30:53 EDT</em></p>
<!-- Local Variables:
time-stamp-format: "%04y-%02m-%02d %02H:%02M:%02S %Z"
time-stamp-start: "\\*Last edited:[ \t]+\\\\?"
time-stamp-end: "\\*\\\\?\n"
time-stamp-line-limit: -20
End: -->
</div>
    </div>
    <script>var pfHeaderImgUrl = '';var pfHeaderTagline = '';var pfdisableClickToDel = 0;var pfHideImages = 0;var pfImageDisplayStyle = 'right';var pfDisablePDF = 0;var pfDisableEmail = 0;var pfDisablePrint = 0;var pfCustomCSS = '';var pfBtVersion='2';(function(){var js,pf;pf=document.createElement('script');pf.type='text/javascript';pf.src='//cdn.printfriendly.com/printfriendly.js';document.getElementsByTagName('head')[0].appendChild(pf)})();</script><a href="https://www.printfriendly.com" style="color:#6D9F00;text-decoration:none;" class="printfriendly" onclick="window.print();return false;" title="Printer Friendly and PDF"><img style="border:none;-webkit-box-shadow:none;box-shadow:none;" src="//cdn.printfriendly.com/buttons/printfriendly-pdf-button.png" alt="Print Friendly and PDF"></a>    
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../../categories/bash/" rel="tag">bash</a></li>
            <li><a class="tag p-category" href="../../../../../categories/logging/" rel="tag">logging</a></li>
            <li><a class="tag p-category" href="../../../../../categories/unix/" rel="tag">unix</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../06/another-thing-i-really-liked-about-advanced-fighting-fantasy-1e/" rel="prev" title="Another Thing I Really Liked About Advanced Fighting Fantasy 1E">Previous post</a>
            </li>
            <li class="next">
                <a href="../advanced-fighting-fantasy-2e-combat-companion/" rel="next" title="Advanced Fighting Fantasy 2E Combat Companion">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="lacking-natural-simplicity",
            disqus_url="https://tkurtbond.github.io/posts/2021/07/07/logging-the-output-of-long-commands-run-multiple-times/",
        disqus_title="Logging the output of long commands run multiple times",
        disqus_identifier="cache/posts/2021/07/07/logging-the-output-of-long-commands-run-multiple-times.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="lacking-natural-simplicity";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
            <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
                    <div class="sidebar-module sidebar-module-inset">
      <h4>About</h4>
      <p>Lacking Natural Simplicity is one, not particularly flattering, 
         definition of sophisticated.  
         This blog chronicles my journey through our at times too complicated 
         and sophisticated world. </p>
    </div>
    <div class="sidebar-module">
      <h4>Links</h4>
      <ol class="list-unstyled">
<li><a href="../../../../../pages/about-the-blog/index.html">About the Blog</a></li>
        <li><a href="../../../../../pages/colophon/index.html">Colophon</a></li>
        <li><a href="../../../../../pages/static-pages-index/index.html">Pages</a></li>
        <li>
<a href="http://tkb.tx0.org/">My other web page</a>
            <p>    Mostly empty</p>
        </li>
      </ol>
</div>
    
            </div>
        <!--End of body content-->
        </div>
    </div>
</div>

<footer class="blog-footer" id="footer">
    Contents © 2021         <a href="mailto:tkurtbond@gmail.com">T. Kurt Bond</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
    
</footer><script src="../../../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
